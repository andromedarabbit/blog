{{ if and (.IsPage) ($.Param "comments_enabled") (not (eq .Type "page")) }}
<div class="comments">

{{ if eq .Section "post" }}
{{ $related := (where .Site.RegularPages "Section" "post").Related . | first 5 }}
{{ with $related }}
<h3>See Also</h3>
<ul>
    {{ range . }}
    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
    {{ end }}
</ul>
{{ end }}
{{ end }}

<div id="comments" class="comments-title"><h3>Comments</h3></div>


{{ range .Resources.Match "comment-*.json" }}
{{ $data := . | transform.Unmarshal }}
<div class="comment">
    <h4 class="p-name">Comment by 
            {{ if $data.url }}
                <a href="{{ $data.url }}">{{ $data.name }}</a>
            {{ else }}
                <span class='linkless-commenter'>{{ $data.name }} </span>
            {{ end }}
            on <a href="#{{ $data.id  }}">{{ $data.date }}</a></h4>
    {{ $data.text }}
</div>
{{ end }}

{{ if .Site.Params.comments_endpoint }}
<form id="comments-form" action="{{ .Site.Params.comments_endpoint }}" method="POST">
    <p><input name="name" placeholder="Your name" required /></p>
    <p><input name="url" placeholder="Your URL (optional)" /></p>
    <p><textarea name="content" required placeholder="Your comment (markdown supported). Comments will be reviewed before appearing on the site." rows="5"></textarea></p>

    {{ if .Site.Params.recaptcha_key }}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script>
        var form = document.getElementById('comments-form');
        form.addEventListener("submit", function(event){
            if (grecaptcha.getResponse() === '') {                            
            event.preventDefault();
            alert('Please check the recaptcha');
            }
        }
        , false);
    </script>
    <div class="g-recaptcha" data-sitekey="{{ .Site.Params.recaptcha_key }}" data-size="compact"></div>
    {{ end }}

    <button type="submit" >Submit comment</button>
</form>
{{ end }}

</div>

{{ end }}
