{{ if and (.IsPage) ($.Param "comments_enabled") (not (eq .Type "page")) }}
<div class="comments">

{{ if eq .Section "post" }}
{{ $related := (where .Site.RegularPages "Section" "post").Related . | first 5 }}
{{ with $related }}
<h3>See Also</h3>
<ul>
    {{ range . }}
    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
    {{ end }}
</ul>
{{ end }}
{{ end }}

{{ with .Resources.Match "like-*.json" }}
<div id="likes" class="likes-title"><h3>Likes</h3></div>
{{ range . }}
{{ $data := . | transform.Unmarshal }}
<a href="{{ $data.url }}"><i class="far fa-heart"></i> {{ $data.name }}</a>
{{ end }}
{{ end }}

{{ with .Resources.Match "comment-*.json" }}
<div id="header-comments" class="comments-title"><h3>Comments</h3></div>
{{ range sort . "Name" "asc" }}
{{ $data := . | transform.Unmarshal }}
<div class="comment">
    {{ with $data.photo }}
    <a href="{{ $data.url }}">
        <img class="commenter-photo" src="{{ . }}" alt="{{ $data.name }}" />
    </a>
    {{ end }}
        {{ if $data.url }}
            <a href="{{ $data.url }}">{{ $data.name }}</a>
        {{ else }}
            <span class='linkless-commenter'>{{ $data.name }} </span>
        {{ end }}
        on <a href="{{ if $data.mention_url }}{{ $data.mention_url }}{{ else }}{{ $data.url }}{{ end }}">{{ $data.date }}</a>:
    {{ $data.text | markdownify }}
</div>
{{ end }}
{{ end }}


<div class="feedback">If you enjoyed my content for some reason, I'd love to hear from you! Here are some options:
<ul>
{{ range .Params.syndicated }}
    {{ if eq .type "twitter" }}
    <li>You can <a href="{{ .url }}">share or reply to this post on Twitter</a>. {{ if eq .Section "post" }}Replies will appear as comments in this section.{{ end }}</li>
    {{ end }}
{{ end }}
{{ if eq .Section "post" }}
{{ if .Site.Params.comments_endpoint }}
<li>You can submit a comment using the form below.
<form id="comments-form" action="{{ .Site.Params.comments_endpoint }}" method="POST">
        <p><input name="name" placeholder="Your name" required maxlength="200" />
            <input name="email" maxlength="200" placeholder="Your Email (optional, won't be published)" />
            <input name="url" maxlength="500" placeholder="Your URL (optional)" /></p>
        <p><textarea name="content" required placeholder="Your comment (markdown supported). Comments will be reviewed before appearing on the site." rows="3"></textarea></p>
    
        {{ if .Site.Params.recaptcha_key }}
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
        <script>
            var form = document.getElementById('comments-form');
            form.addEventListener("submit", function(event){
                if (grecaptcha.getResponse() === '') {                            
                event.preventDefault();
                alert('Please check the recaptcha');
                }
            }
            , false);
        </script>
        <div class="g-recaptcha" data-sitekey="{{ .Site.Params.recaptcha_key }}" data-size="compact"></div>
        {{ end }}
    
        <button type="submit" >Submit your comment</button>
    </form>
</li>    
{{ end }}    
{{ end }}
{{ $webmentionTarget := .Permalink }}
{{ with .Site.Params.webmention_username }}  
<li>You can write a reply on your own site and submit the URL as a <a href="https://indieweb.org/webmention">webmention</a> via the form below. (Experimental!)
    <form id="webmention-form" action="https://webmention.io/{{ . }}/webmention" method="POST">
        <input name="target" value="{{ $webmentionTarget }}" type="hidden" />
        <input name="source" placeholder="Your reply URL" style="width:90%" required />
        <button type="submit" >Submit</button>
    </form>
</li>
{{ end }}
<li>Or you can just <a href="mailto:{{ .Site.Author.email }}">email me</a>!</li>
</ul>
</div>

{{ end }}
